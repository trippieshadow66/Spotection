<!-- templates/home.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spotection Project - Smart Parking Solutions</title>
  <style>
    /* Reset and Base Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --parking-dark: #1e2d3b;
      --parking-navy: #2c3e50;
      --parking-grey: #34495e;
      --parking-green: #27ae60;
      --parking-lime: #2ecc71;
      --parking-yellow: #f1c40f;
      --parking-orange: #e67e22;
      --text-light: #ecf0f1;
      --text-lighter: #ffffff;
      --background-dark: #1a252f;
    }

    body {
      font-family: 'Arial', sans-serif;
      line-height: 1.6;
      color: var(--text-light);
      background-color: var(--background-dark);
      scroll-behavior: smooth;
    }

    html {
      scroll-behavior: smooth;
      scroll-padding-top: 80px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }

    /* Dropdown Styles */
    .dropdown {
      position: relative;
      display: inline-block;
    }

    .dropdown-toggle {
      background: var(--parking-grey);
      color: var(--text-light);
      border: 2px solid var(--parking-yellow);
      padding: 1rem 2rem;
      border-radius: 8px;
      font-size: 1.1rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      min-width: 200px;
      justify-content: space-between;
    }

    .dropdown-toggle:hover {
      background: var(--parking-yellow);
      color: var(--parking-navy);
      transform: translateY(-2px);
    }

    .dropdown-toggle::after {
      content: '▼';
      font-size: 0.8rem;
      transition: transform 0.3s ease;
    }

    .dropdown-toggle.open::after {
      transform: rotate(180deg);
    }

    .dropdown-menu {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--parking-navy);
      border: 2px solid var(--parking-yellow);
      border-radius: 8px;
      margin-top: 0.5rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      display: none;
      overflow: hidden;
    }

    .dropdown-menu.show {
      display: block;
      animation: fadeInUp 0.3s ease;
    }

    .dropdown-item {
      padding: 1rem 1.5rem;
      color: var(--text-light);
      text-decoration: none;
      display: block;
      transition: all 0.3s ease;
      border-bottom: 1px solid var(--parking-grey);
      cursor: pointer;
    }

    .dropdown-item:last-child {
      border-bottom: none;
    }

    .dropdown-item:hover {
      background: var(--parking-yellow);
      color: var(--parking-navy);
    }

    .dropdown-item.active {
      background: var(--parking-yellow);
      color: var(--parking-navy);
      font-weight: bold;
    }

    /* Login System Styles */
    .login-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(26, 37, 47, 0.95);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      backdrop-filter: blur(10px);
    }

    .login-container {
      background: var(--parking-navy);
      padding: 3rem;
      border-radius: 15px;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
      border: 2px solid var(--parking-yellow);
      max-width: 400px;
      width: 90%;
      text-align: center;
    }

    .login-container h2 {
      color: var(--parking-yellow);
      margin-bottom: 1.5rem;
      font-size: 2rem;
    }

    .login-form {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .form-group {
      text-align: left;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--text-light);
      font-weight: bold;
    }

    .form-group input {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--parking-grey);
      border-radius: 8px;
      background: var(--background-dark);
      color: var(--text-light);
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }

    .form-group input:focus {
      outline: none;
      border-color: var(--parking-yellow);
    }

    .login-button {
      background: linear-gradient(135deg, var(--parking-yellow), var(--parking-orange));
      color: var(--parking-navy);
      border: none;
      padding: 15px;
      font-size: 1.1rem;
      font-weight: bold;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 1rem;
      width: 100%;
    }

    .login-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(241, 196, 15, 0.4);
    }

    .guest-button {
      background: var(--parking-grey);
      color: var(--text-light);
      border: 2px solid var(--parking-yellow);
      padding: 15px;
      font-size: 1.1rem;
      font-weight: bold;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 0.5rem;
      width: 100%;
    }

    .guest-button:hover {
      background: var(--parking-yellow);
      color: var(--parking-navy);
      transform: translateY(-2px);
    }

    .login-error {
      color: #e74c3c;
      margin-top: 1rem;
      display: none;
    }

    .admin-controls {
      display: flex;
      gap: 1rem;
      align-items: center;
      margin-left: 2rem;
    }

    .admin-button {
      background: var(--parking-green);
      color: var(--text-lighter);
      border: none;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }

    .admin-button:hover {
      background: var(--parking-lime);
      transform: translateY(-2px);
    }

    .delete-button {
      background: #e74c3c;
    }

    .delete-button:hover {
      background: #c0392b;
    }

    .logout-button {
      background: var(--parking-grey);
      color: var(--text-light);
      border: 1px solid var(--parking-yellow);
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .logout-button:hover {
      background: var(--parking-yellow);
      color: var(--parking-navy);
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 3000;
      backdrop-filter: blur(5px);
    }

    .modal {
      background: var(--parking-navy);
      padding: 2rem;
      border-radius: 15px;
      border: 2px solid var(--parking-yellow);
      max-width: 500px;
      width: 90%;
    }

    .modal h3 {
      color: var(--parking-yellow);
      margin-bottom: 1.5rem;
      text-align: center;
    }

    .modal-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-top: 2rem;
    }

    .modal-confirm {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
    }

    .modal-cancel {
      background: var(--parking-grey);
      color: var(--text-light);
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
    }

    /* Navigation */
    .navbar {
      background-color: var(--parking-navy);
      padding: 1rem 0;
      position: fixed;
      width: 100%;
      top: 0;
      z-index: 1000;
      border-bottom: 3px solid var(--parking-yellow);
      box-shadow: 0 2px 20px rgba(0, 0, 0, 0.5);
      transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    .nav-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo h2 {
      color: var(--text-lighter);
      font-size: 1.8rem;
      font-weight: bold;
      transition: transform 0.3s ease;
    }

    .logo h2:hover {
      transform: scale(1.05);
    }

    .nav-menu {
      display: flex;
      list-style: none;
      gap: 2rem;
      align-items: center;
    }

    .nav-menu a {
      color: var(--text-light);
      text-decoration: none;
      font-weight: 500;
      transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      position: relative;
      padding: 0.5rem 0;
    }

    .nav-menu a:hover {
      color: var(--parking-yellow);
      transform: translateY(-2px);
    }

    .nav-menu a::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 0;
      height: 2px;
      background-color: var(--parking-yellow);
      transition: width 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    .nav-menu a:hover::after {
      width: 100%;
    }

    /* Hero Section */
    .hero {
      background: linear-gradient(135deg, var(--parking-dark) 0%, var(--parking-navy) 100%);
      color: var(--text-lighter);
      padding: 150px 0 80px;
      text-align: center;
      animation: fadeInUp 0.8s ease-out;
      position: relative;
      overflow: hidden;
    }

    .hero::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background:
        radial-gradient(circle at 20% 80%, rgba(241, 196, 15, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(46, 204, 113, 0.1) 0%, transparent 50%);
      z-index: 1;
    }

    .hero-content {
      position: relative;
      z-index: 2;
    }

    .hero-content h1 {
      font-size: 3.5rem;
      margin-bottom: 1.5rem;
      font-weight: bold;
      animation: slideInFromTop 0.8s ease-out 0.2s both;
      background: linear-gradient(135deg, var(--parking-yellow), var(--parking-lime));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .hero-content p {
      font-size: 1.3rem;
      margin-bottom: 2.5rem;
      opacity: 0.9;
      animation: slideInFromTop 0.8s ease-out 0.4s both;
    }

    /* Overlay Section */
    .overlay-container {
      max-width: 1000px;
      margin: 2rem auto;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      padding: 30px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
    }

    .overlay-wrapper {
      position: relative;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
      margin-bottom: 40px;
      text-align: center;
      padding: 20px;
      background: rgba(0, 0, 0, 0.3);
    }

    .overlay-wrapper:last-child {
      margin-bottom: 0;
    }

    .overlay-wrapper h2 {
      margin-bottom: 20px;
      text-align: center;
      color: var(--parking-yellow);
      font-size: 1.5rem;
      padding: 10px;
    }

    .overlay-image {
      max-width: 100%;
      max-height: 450px;
      width: auto;
      height: auto;
      display: block;
      margin: 0 auto;
      transition: transform 0.3s ease;
      background-color: var(--background-dark);
    }

    .overlay-image:hover {
      transform: scale(1.02);
    }

    /* Live Stats Overlay */
    .overlay-stats {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
      padding: 2rem 1rem 1rem;
      display: flex;
      justify-content: space-around;
      align-items: center;
    }

    .live-stat {
      text-align: center;
      color: white;
    }

    .stat-number {
      display: block;
      font-size: 2.5rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
    }

    .stat-label {
      font-size: 0.9rem;
      opacity: 0.9;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .last-updated-small {
      text-align: center;
      color: var(--parking-yellow);
      font-size: 0.9rem;
      margin-top: 1rem;
      font-style: italic;
    }

    /* Mission Section */
    .mission {
      padding: 100px 0;
      background-color: var(--parking-grey);
      animation: fadeIn 0.8s ease-out;
      border-top: 1px solid rgba(241, 196, 15, 0.3);
      border-bottom: 1px solid rgba(241, 196, 15, 0.3);
    }

    .mission-content h2 {
      color: var(--parking-yellow);
      font-size: 2.5rem;
      margin-bottom: 2rem;
      text-align: center;
      animation: slideInFromLeft 0.8s ease-out;
    }

    .mission-content p {
      margin-bottom: 1.5rem;
      font-size: 1.2rem;
      line-height: 1.8;
      animation: slideInFromRight 0.8s ease-out 0.2s both;
      text-align: center;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
      color: var(--text-light);
    }

    /* About Section */
    .about {
      padding: 100px 0;
      background-color: var(--parking-dark);
    }

    .about-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 3rem;
      align-items: center;
    }

    .about-text h2 {
      color: var(--parking-lime);
      font-size: 2.5rem;
      margin-bottom: 1.5rem;
      animation: slideInFromLeft 0.8s ease-out;
    }

    .about-text p {
      margin-bottom: 1.5rem;
      font-size: 1.2rem;
      line-height: 1.7;
      animation: slideInFromLeft 0.8s ease-out 0.2s both;
      color: var(--text-light);
    }

    /* Campus Image Styles */
    .campus-image {
      width: 100%;
      height: 350px;
      object-fit: cover;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      animation: slideInFromRight 0.8s ease-out 0.3s both;
      border: 2px solid var(--parking-yellow);
    }

    .campus-image:hover {
      transform: scale(1.03);
      box-shadow: 0 15px 40px rgba(241, 196, 15, 0.2);
    }

    .hidden { display: none !important; }

    /* Footer */
    .footer {
      background-color: var(--parking-navy);
      color: var(--text-light);
      padding: 40px 0;
      animation: fadeIn 0.8s ease-out;
      border-top: 3px solid var(--parking-yellow);
    }

    .footer-content {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .footer-info p {
      margin-bottom: 0.5rem;
      transition: opacity 0.3s ease;
      text-align: center;
      font-size: 1.1rem;
      color: var(--parking-yellow);
    }

    .footer-info:hover p {
      opacity: 0.9;
    }

    /* Animations */
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideInFromTop { from { opacity: 0; transform: translateY(-50px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideInFromLeft { from { opacity: 0; transform: translateX(-50px); } to { opacity: 1; transform: translateX(0); } }
    @keyframes slideInFromRight { from { opacity: 0; transform: translateX(50px); } to { opacity: 1; transform: translateX(0); } }

    @media (max-width: 768px) {
      .nav-menu { flex-direction: column; gap: 1rem; }
      .hero-content h1 { font-size: 2.5rem; }
      .about-content { grid-template-columns: 1fr; }
      .campus-image { height: 250px; }
      .overlay-image { max-height: 300px; }
      .overlay-stats { flex-direction: column; gap: 0.5rem; padding: 1rem; }
      .admin-controls { flex-direction: column; margin-left: 0; }
      .dropdown-toggle { min-width: 180px; }
    }
  </style>
</head>
<body>
  <!-- Login Overlay -->
  <div id="loginOverlay" class="login-overlay">
    <div class="login-container">
      <h2>Spotection Project</h2>
      <form id="loginForm" class="login-form">
        <div class="form-group">
          <label for="username">Username</label>
          <input type="text" id="username" placeholder="Enter your username" required>
        </div>
        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" id="password" placeholder="Enter your password" required>
        </div>
        <button type="submit" class="login-button">Login as Admin</button>
        <button type="button" id="guestButton" class="guest-button">Continue as Guest</button>
        <div id="loginError" class="login-error">
          Invalid username or password
        </div>
      </form>
      <div style="margin-top: 2rem; color: var(--text-light); font-size: 0.9rem;">
        
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="deleteModal" class="modal-overlay hidden">
    <div class="modal">
      <h3>Delete Parking Lot</h3>
      <p>Are you sure you want to delete "<span id="deleteLotName"></span>"?</p>
      <p style="color: #e74c3c; font-size: 0.9rem; margin-top: 1rem;">This action cannot be undone.</p>
      <div class="modal-buttons">
        <button id="confirmDelete" class="modal-confirm">Delete</button>
        <button id="cancelDelete" class="modal-cancel">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Add Parking Lot Modal -->
  <div id="addLotModal" class="modal-overlay hidden">
    <div class="modal">
      <h3>Add New Parking Lot</h3>
      <form id="addLotForm" class="login-form">
        <div class="form-group">
          <label for="lotName">Parking Lot Name</label>
          <input type="text" id="lotName" placeholder="e.g., West Campus Lot" required>
        </div>
        <div class="form-group">
          <label for="totalSpots">Total Parking Spots</label>
          <input type="number" id="totalSpots" placeholder="e.g., 50" required min="1">
        </div>
        <div class="form-group">
          <label for="cameraUrl">Camera Feed URL (Optional)</label>
          <input type="text" id="cameraUrl" placeholder="http://...">
        </div>
        <div class="modal-buttons">
          <button type="submit" class="login-button">Add Parking Lot</button>
          <button type="button" id="cancelAdd" class="modal-cancel">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Navigation -->
  <nav class="navbar">
    <div class="nav-container">
      <div class="logo">
        <h2>Spotection Project</h2>
      </div>
      <ul class="nav-menu">
        <li><a href="#mission">Mission</a></li>
        <li><a href="#about">Technology</a></li>
        <!-- Dynamic parking lot dropdown will be added here -->
        <div id="parkingLotDropdown"></div>
        <div class="admin-controls hidden" id="adminControls">
          <button class="admin-button" id="addLotButton">Add Parking Lot</button>
          <button class="admin-button" id="editConfigButton">Edit Current Lot Config</button>
          <button class="admin-button delete-button" id="deleteLotButton">Delete Current Lot</button>
          <button class="logout-button" id="logoutButton">Logout</button>
        </div>
        <div class="admin-controls hidden" id="guestControls">
          <button class="logout-button" id="guestLogoutButton">Switch to Admin</button>
        </div>
      </ul>
    </div>
  </nav>

  <!-- Main Content -->
  <div id="mainContent" class="hidden">
    <!-- Dynamic parking lot content will be added here -->
    <div id="parkingLotContent"></div>

    <!-- Footer -->
    <footer class="footer">
      <div class="footer-content">
        <div class="footer-info">
          <p>Spotection Project — Making Parking Easier</p>
        </div>
      </div>
    </footer>
  </div>

  <script>
    // Parking Lot Management System (API-driven)
    document.addEventListener('DOMContentLoaded', function() {
      // DOM Elements
      const loginOverlay = document.getElementById('loginOverlay');
      const mainContent = document.getElementById('mainContent');
      const loginForm = document.getElementById('loginForm');
      const loginError = document.getElementById('loginError');
      const guestButton = document.getElementById('guestButton');
      const logoutButton = document.getElementById('logoutButton');
      const guestLogoutButton = document.getElementById('guestLogoutButton');
      const adminControls = document.getElementById('adminControls');
      const guestControls = document.getElementById('guestControls');
      const addLotButton = document.getElementById('addLotButton');
      const deleteLotButton = document.getElementById('deleteLotButton');
      const editConfigButton = document.getElementById('editConfigButton');
      const parkingLotDropdown = document.getElementById('parkingLotDropdown');
      const parkingLotContent = document.getElementById('parkingLotContent');
      const deleteModal = document.getElementById('deleteModal');
      const addLotModal = document.getElementById('addLotModal');
      const addLotForm = document.getElementById('addLotForm');
      const cancelAdd = document.getElementById('cancelAdd');
      const cancelDelete = document.getElementById('cancelDelete');
      const confirmDelete = document.getElementById('confirmDelete');
      const deleteLotName = document.getElementById('deleteLotName');

      // Demo credentials
      const validCredentials = {
        username: 'admin',
        password: 'spotection123'
      };

      // Parking lots state (loaded from backend, NOT localStorage)
      let parkingLots = [];
      let currentLotId = null;
      let lotToDelete = null;
      let isGuestMode = false;

      // API helpers
      async function apiGetLots() {
        const res = await fetch('/api/lots');
        if (!res.ok) throw new Error('Failed to load lots');
        return res.json();
      }

      async function apiCreateLot(payload) {
        const res = await fetch('/api/lots', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error('Failed to create lot');
        return res.json();
      }

      async function apiDeleteLot(lotId) {
        const res = await fetch(`/api/lots/${lotId}`, {
          method: 'DELETE'
        });
        if (!res.ok) throw new Error('Failed to delete lot');
        return res.json().catch(() => ({}));
      }

      async function apiGetStats(lot) {
        if (!lot.statsUrl) return null;
        const res = await fetch(lot.statsUrl);
        if (!res.ok) return null;
        return res.json();
      }

      // Check if user is already logged in
      if (localStorage.getItem('isLoggedIn') === 'true') {
        showMainContent(false);
      } else if (localStorage.getItem('isGuestMode') === 'true') {
        showMainContent(true);
      }

      // Login form submission
      loginForm.addEventListener('submit', function(e) {
        e.preventDefault();

        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value.trim();

        if (username === validCredentials.username && password === validCredentials.password) {
          localStorage.setItem('isLoggedIn', 'true');
          localStorage.removeItem('isGuestMode');
          showMainContent(false);
        } else {
          loginError.style.display = 'block';
          setTimeout(() => {
            loginError.style.display = 'none';
          }, 3000);
        }
      });

      // Guest button functionality
      guestButton.addEventListener('click', function() {
        localStorage.setItem('isGuestMode', 'true');
        localStorage.removeItem('isLoggedIn');
        showMainContent(true);
      });

      // Admin logout functionality
      logoutButton.addEventListener('click', function() {
        localStorage.removeItem('isLoggedIn');
        showLogin();
      });

      // Guest logout functionality (switch to admin)
      guestLogoutButton.addEventListener('click', function() {
        localStorage.removeItem('isGuestMode');
        showLogin();
      });

      // Add parking lot
      addLotButton.addEventListener('click', function() {
        addLotModal.classList.remove('hidden');
      });

      // Cancel add parking lot
      cancelAdd.addEventListener('click', function() {
        addLotModal.classList.add('hidden');
        addLotForm.reset();
      });

      // Submit add parking lot form
      addLotForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        const lotName = document.getElementById('lotName').value.trim();
        const totalSpots = parseInt(document.getElementById('totalSpots').value, 10);
        const cameraUrl = document.getElementById('cameraUrl').value.trim() || null;

        try {
          const newLot = await apiCreateLot({
            name: lotName,
            totalSpots: totalSpots,
            cameraUrl: cameraUrl
          });

          const normalized = normalizeLot(newLot);
          parkingLots.push(normalized);
          currentLotId = normalized.id;
          renderParkingLots();
          switchToLot(normalized.id);

          addLotModal.classList.add('hidden');
          addLotForm.reset();
        } catch (err) {
          alert('Error creating lot: ' + err.message);
        }
      });

      // Delete parking lot
      deleteLotButton.addEventListener('click', function() {
        if (parkingLots.length <= 1) {
          alert('You must have at least one parking lot.');
          return;
        }

        const currentLot = parkingLots.find(lot => lot.id === currentLotId);
        if (!currentLot) return;

        lotToDelete = currentLot.id;
        deleteLotName.textContent = currentLot.name;
        deleteModal.classList.remove('hidden');
      });

      // Confirm delete
      confirmDelete.addEventListener('click', async function() {
        if (!lotToDelete) return;

        try {
          await apiDeleteLot(lotToDelete);
          await loadLotsFromServer();     // << reload REAL list from backend
          renderParkingLots();
          if (currentLotId) switchToLot(currentLotId);

          if (parkingLots.length > 0) {
            currentLotId = parkingLots[0].id;
          } else {
            currentLotId = null;
          }

          renderParkingLots();
          if (currentLotId) {
            switchToLot(currentLotId);
          }

        } catch (err) {
          alert('Error deleting lot: ' + err.message);
        }

        deleteModal.classList.add('hidden');
        lotToDelete = null;
      });

      // Cancel delete
      cancelDelete.addEventListener('click', function() {
        deleteModal.classList.add('hidden');
        lotToDelete = null;
      });

      // Edit current lot config
      editConfigButton.addEventListener('click', function() {
        if (!currentLotId) {
          alert('No lot selected.');
          return;
        }
        window.location.href = `/admin/lot-config/${currentLotId}`;
      });

      function showMainContent(guestMode) {
        isGuestMode = guestMode;
        loginOverlay.classList.add('hidden');
        mainContent.classList.remove('hidden');

        if (guestMode) {
          adminControls.classList.add('hidden');
          guestControls.classList.remove('hidden');
        } else {
          adminControls.classList.remove('hidden');
          guestControls.classList.add('hidden');
        }

        // Load lots from backend then init dashboard
        loadLotsFromServer().then(() => {
          initializeDashboard();
        }).catch(err => {
          console.error(err);
          alert('Failed to load parking lots from server.');
        });
      }

      function showLogin() {
        loginOverlay.classList.remove('hidden');
        mainContent.classList.add('hidden');
        adminControls.classList.add('hidden');
        guestControls.classList.add('hidden');
        loginForm.reset();
      }

      async function loadLotsFromServer() {
        const data = await apiGetLots();
        const lots = (data && data.lots) ? data.lots : [];

        parkingLots = lots.map(normalizeLot);

        if (parkingLots.length > 0) {
          if (!currentLotId || !parkingLots.some(l => l.id === currentLotId)) {
            currentLotId = parkingLots[0].id;
          }
        } else {
          currentLotId = null;
        }

        renderParkingLots();
        if (currentLotId) {
          switchToLot(currentLotId);
        }
      }

      // Normalize lot object keys to a consistent shape for the frontend
      function normalizeLot(raw) {
        return {
          id: raw.id,
          name: raw.name,
          totalSpots: raw.totalSpots ?? raw.total_spots ?? 0,
          availableSpots: raw.availableSpots ?? 0,
          rawFeed: raw.rawFrame,                     // ✅ NEW — latest frame
          overlayFeed: raw.overlayFeed,
          mapImage: raw.mapImage,
          statsUrl: raw.apiEndpoint
        };
}

      function renderParkingLots() {
        // Render navigation dropdown
        parkingLotDropdown.innerHTML = '';

        if (parkingLots.length > 0) {
          const dropdown = document.createElement('div');
          dropdown.className = 'dropdown';

          const currentLot = parkingLots.find(lot => lot.id === currentLotId);
          const dropdownToggle = document.createElement('button');
          dropdownToggle.className = 'dropdown-toggle';
          dropdownToggle.innerHTML = `${currentLot ? currentLot.name : 'Select Lot'}`;

          const dropdownMenu = document.createElement('div');
          dropdownMenu.className = 'dropdown-menu';

          parkingLots.forEach(lot => {
            const dropdownItem = document.createElement('div');
            dropdownItem.className = 'dropdown-item' + (lot.id === currentLotId ? ' active' : '');
            dropdownItem.textContent = lot.name;
            dropdownItem.dataset.lotId = lot.id;
            dropdownItem.addEventListener('click', () => {
              switchToLot(lot.id);
              dropdownToggle.textContent = lot.name;
              dropdownMenu.classList.remove('show');
              dropdownToggle.classList.remove('open');
            });
            dropdownMenu.appendChild(dropdownItem);
          });

          dropdownToggle.addEventListener('click', () => {
            dropdownMenu.classList.toggle('show');
            dropdownToggle.classList.toggle('open');
          });

          // Close dropdown when clicking outside
          document.addEventListener('click', (e) => {
            if (!dropdown.contains(e.target)) {
              dropdownMenu.classList.remove('show');
              dropdownToggle.classList.remove('open');
            }
          });

          dropdown.appendChild(dropdownToggle);
          dropdown.appendChild(dropdownMenu);
          parkingLotDropdown.appendChild(dropdown);
        }

        // Render parking lot content
        parkingLotContent.innerHTML = '';
        parkingLots.forEach(lot => {
          const lotDiv = document.createElement('div');
          lotDiv.id = `parking-lot-${lot.id}`;
          lotDiv.className = 'hidden parking-lot';

          const occupancyPercent = lot.totalSpots
            ? Math.round(100 - (lot.availableSpots / lot.totalSpots * 100))
            : 0;

          lotDiv.innerHTML = `
            <section class="hero">
              <div class="hero-content">
                <h1>Live Parking Detection Dashboard</h1>
                <p>AI-powered detection delivering real-time stall availability and map visualization</p>

                <div class="overlay-container">
                  <!-- Live Feed -->
                  <div class="overlay-wrapper">
                    <h2>Live Camera Feed - ${lot.name}</h2>
                    <img id="live-raw-${lot.id}" src="/frame-latest/${lot.id}" class="overlay-image">
                  </div>

                  <!-- AI Overlay View -->
                  <div class="overlay-wrapper">
                    <h2>Camera Detection View - ${lot.name}</h2>
                    <img id="live-overlay-${lot.id}" src="${lot.overlayFeed}" alt="AI Overlay" class="overlay-image">
                  </div>

                  <!-- Top-Down Map -->
                  <div class="overlay-wrapper">
                    <h2>Top-Down Parking Map - ${lot.name}</h2>
                    <img id="live-map-${lot.id}" src="${lot.mapImage}" alt="Top-Down Map" class="overlay-image">
                  </div>

                  <!-- Stats -->
                  <div class="overlay-stats">
                    <div class="live-stat">
                      <span class="stat-number" id="hero-available-${lot.id}">${lot.availableSpots}</span>
                      <span class="stat-label">Available Spots</span>
                    </div>
                    <div class="live-stat">
                      <span class="stat-number" id="hero-total-${lot.id}">${lot.totalSpots}</span>
                      <span class="stat-label">Total Spots</span>
                    </div>
                    <div class="live-stat">
                      <span class="stat-number" id="hero-occupancy-${lot.id}">${occupancyPercent}%</span>
                      <span class="stat-label">Occupancy</span>
                    </div>
                  </div>

                  <div class="last-updated-small">
                    Last updated: <span id="hero-update-time-${lot.id}">${new Date().toLocaleTimeString()}</span>
                  </div>
                </div>
              </div>
            </section>

            <!-- Mission Section -->
            <section id="mission" class="mission">
              <div class="container">
                <div class="mission-content">
                  <h2>Our Parking Mission</h2>
                  <p>Our goal is to make parking more convenient and easier for students, faculty, staff, and visitors by providing live, AI-powered stall availability.</p>
                </div>
              </div>
            </section>

            <!-- Technology Section -->
            <section id="about" class="about">
              <div class="container">
                <div class="about-content">
                  <div class="about-text">
                    <h2>How It Works</h2>
                    <p>Using advanced computer vision and real-time data analytics, the Spotection system identifies which parking stalls are occupied and which are free. It continuously processes camera frames, generates an overlay, and updates a simplified top-down map.</p>
                    <p>Each lot can be configured entirely from this web interface — including stall boundaries, camera configuration, and live occupancy visualization — without touching any backend code directly.</p>
                  </div>
                  <div class="about-image">
                    <img src="{{ url_for('static', filename='images/image.png') }}" alt="Campus Parking" class="campus-image">
                  </div>
                </div>
              </div>
            </section>
          `;

          parkingLotContent.appendChild(lotDiv);
        });

        if (currentLotId) {
          switchToLot(currentLotId);
        }
      }

      function switchToLot(lotId) {
        currentLotId = lotId;

        // Hide all parking lots
        document.querySelectorAll('.parking-lot').forEach(lot => {
          lot.classList.add('hidden');
        });

        // Show selected parking lot
        const selectedLot = document.getElementById(`parking-lot-${lotId}`);
        if (selectedLot) {
          selectedLot.classList.remove('hidden');
        }

        // Update navigation dropdown
        const currentLot = parkingLots.find(lot => lot.id === currentLotId);
        const dropdownToggle = document.querySelector('#parkingLotDropdown .dropdown-toggle');
        if (dropdownToggle && currentLot) {
          dropdownToggle.textContent = currentLot.name;
        }

        // Update active states in dropdown menu
        document.querySelectorAll('#parkingLotDropdown .dropdown-item').forEach(item => {
          item.classList.toggle('active', parseInt(item.dataset.lotId, 10) === lotId);
        });
      }

      function initializeDashboard() {
        console.log("Spotection dashboard running with backend lots…");

        // Start updating parking data
        setInterval(updateParkingData, 4000);

        // Start refreshing overlays
        setInterval(refreshOverlays, 4000);
      }

      async function updateParkingData() {
    for (const lot of parkingLots) {
        // skip lots that have no stats endpoint
        if (!lot.statsUrl) continue;

        // skip nonexistent lots (prevents spam)
        if (!lot || !lot.id) continue;
        if (!document.getElementById(`parking-lot-${lot.id}`)) continue;

        try {
            const stats = await apiGetStats(lot);
            if (!stats) continue;

            const availableElement = document.getElementById(`hero-available-${lot.id}`);
            const totalElement = document.getElementById(`hero-total-${lot.id}`);
            const occupancyElement = document.getElementById(`hero-occupancy-${lot.id}`);
            const updateTimeElement = document.getElementById(`hero-update-time-${lot.id}`);

            const newAvailable = stats.available ?? 0;
            const newTotal = stats.total ?? lot.totalSpots ?? 0;
            const occupancy = newTotal ? (newTotal - newAvailable) / newTotal * 100 : 0;

            lot.availableSpots = newAvailable;
            lot.totalSpots = newTotal;

            if (availableElement) {
                availableElement.textContent = newAvailable;
                if (occupancy > 80) {
                    availableElement.style.color = '#e74c3c';
                } else if (occupancy > 50) {
                    availableElement.style.color = '#f39c12';
                } else {
                    availableElement.style.color = '#27ae60';
                }
            }

            if (totalElement) totalElement.textContent = newTotal;
            if (occupancyElement) occupancyElement.textContent = `${Math.round(occupancy)}%`;
            if (updateTimeElement) updateTimeElement.textContent = stats.last_updated || new Date().toLocaleTimeString();

        } catch (err) {
            console.warn('Failed to update stats for lot', lot.id, err);
        }
    }
}

      function refreshOverlays() {
        const ts = new Date().getTime();
        parkingLots.forEach(lot => {
          const overlayImg = document.getElementById(`live-overlay-${lot.id}`);
          const mapImg = document.getElementById(`live-map-${lot.id}`);
          const rawImg = document.getElementById(`live-raw-${lot.id}`);
          if (!lot || !lot.id) return;

          if (overlayImg) {
            overlayImg.src = `${lot.overlayFeed}?t=${ts}`;
          }
          if (mapImg) {
            mapImg.src = `${lot.mapImage}?t=${ts}`;
          }
          if (rawImg && lot.rawFeed) {
            rawImg.src = `${lot.rawFeed}?t=${ts}`;
          }
        });
      }

      // Initialize the app (if user already logged/guest from previous session)
      if (localStorage.getItem('isLoggedIn') === 'true') {
        showMainContent(false);
      } else if (localStorage.getItem('isGuestMode') === 'true') {
        showMainContent(true);
      }
    });
  </script>
</body>
</html>
